-- [[ 1. THE FOUNDATION: CORE SERVICES ]] --
local player = game.Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")

-- Configuration
local CFG = {
    TPWalkSpeed = 20, -- 1.25x of 16
    ClaimPos = Vector3.new(-48, 12, -128),
    Rarities = {"OG", "God", "Secret"},
    Variants = {"Rainbow", "Galaxy", "Hacker"}
}

local Toggles = {TPWalk = false, Aura = false}
local CurrentTPWalk = nil

-- [[ 2. UI ARCHITECT (BUILT TO NEVER FAIL) ]] --
local ScreenGui = Instance.new("ScreenGui", PlayerGui)
ScreenGui.Name = "Nexus_V33"
ScreenGui.ResetOnSpawn = false

local Main = Instance.new("Frame", ScreenGui)
Main.Name = "MainFrame"
Main.Size = UDim2.new(0, 220, 0, 260)
Main.Position = UDim2.new(0.5, -110, 0.3, 0)
Main.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)

local Header = Instance.new("TextLabel", Main)
Header.Size = UDim2.new(1, 0, 0, 35)
Header.BackgroundColor3 = Color3.fromRGB(85, 0, 255)
Header.Text = "NEXUS V33 | ELITE"
Header.TextColor3 = Color3.new(1, 1, 1)
Header.Font = Enum.Font.GothamBold
Header.TextSize = 14
local HeaderCorner = Instance.new("UICorner", Header)

-- Scrolling Sidebar for Elites
local Scroll = Instance.new("ScrollingFrame", Main)
Scroll.Size = UDim2.new(0, 160, 1, 0)
Scroll.Position = UDim2.new(1, 5, 0, 0)
Scroll.BackgroundColor3 = Color3.fromRGB(5, 5, 5)
Scroll.BorderSizePixel = 0
Scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
Scroll.ScrollBarThickness = 2
local ScrollList = Instance.new("UIListLayout", Scroll)
ScrollList.Padding = UDim.new(0, 5)

-- Button Helper Function
local function createButton(text, yPos, color, callback)
    local b = Instance.new("TextButton", Main)
    b.Size = UDim2.new(0.9, 0, 0, 35)
    b.Position = UDim2.new(0.05, 0, 0, yPos)
    b.BackgroundColor3 = color
    b.Text = text
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 11
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function()
        task.spawn(callback, b)
    end)
    return b
end

-- [[ 3. GAME LOGIC (OPTIMIZED & PROTECTED) ]] --

-- TPWalk Function (Heartbeat Logic)
local function handleTPWalk()
    if CurrentTPWalk then CurrentTPWalk:Disconnect() end
    CurrentTPWalk = RunService.Heartbeat:Connect(function(dt)
        if Toggles.TPWalk and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local dist = (CFG.ClaimPos - hrp.Position).Magnitude
            if dist > 3 then
                local dir = (CFG.ClaimPos - hrp.Position).Unit
                hrp.CFrame = hrp.CFrame + (dir * CFG.TPWalkSpeed * dt)
            else
                Toggles.TPWalk = false
            end
        end
    end)
end

-- Elite Scanner (Pcall to prevent crashes)
local function updateEliteList()
    for _, item in pairs(Scroll:GetChildren()) do if item:IsA("TextButton") then item:Destroy() end end
    local folder = workspace:FindFirstChild("Brainrots")
    if not folder then return end

    for _, br in pairs(folder:GetChildren()) do
        task.spawn(function()
            local success, _ = pcall(function()
                local frame = br.Mesh.InfoGui.Frame
                local r, v, c = frame.CharRarity.Text, frame.CharVariant.Text, frame.Cooldown.TextLabel.Text
                
                local elite = false
                for _, target in pairs(CFG.Rarities) do if r:find(target) then elite = true end end
                for _, target in pairs(CFG.Variants) do if v:find(target) then elite = true end end

                if elite then
                    local eb = Instance.new("TextButton", Scroll)
                    eb.Size = UDim2.new(1, -10, 0, 40)
                    eb.Text = v.." "..r.."\n"..c
                    eb.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
                    eb.TextColor3 = Color3.new(0, 1, 0.8)
                    eb.TextSize = 8
                    Instance.new("UICorner", eb)
                    eb.MouseButton1Click:Connect(function()
                        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                            player.Character.HumanoidRootPart.CFrame = br:GetPivot()
                        end
                    end)
                end
            end)
        end)
    end
    Scroll.CanvasSize = UDim2.new(0, 0, 0, ScrollList.AbsoluteContentSize.Y + 10)
end

-- [[ 4. BUTTONS & ACTIVATION ]] --

createButton("TPWALK TO CLAIM: OFF", 45, Color3.fromRGB(40, 40, 45), function(self)
    Toggles.TPWalk = not Toggles.TPWalk
    self.Text = "TPWALK TO CLAIM: " .. (Toggles.TPWalk and "ON" or "OFF")
    self.BackgroundColor3 = Toggles.TPWalk and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(40, 40, 45)
    if Toggles.TPWalk then handleTPWalk() end
end)

createButton("MASS AURA: OFF", 90, Color3.fromRGB(40, 40, 45), function(self)
    Toggles.Aura = not Toggles.Aura
    self.Text = "MASS AURA: " .. (Toggles.Aura and "ON" or "OFF")
    self.BackgroundColor3 = Toggles.Aura and Color3.fromRGB(255, 0, 100) or Color3.fromRGB(40, 40, 45)
end)

createButton("REFRESH ELITES", 135, Color3.fromRGB(0, 180, 100), function()
    updateEliteList()
end)

-- [[ 5. BACKGROUND LOOPS ]] --

-- Mass Aura Loop (Sammy + LuckyBlocks)
task.spawn(function()
    local remotes = game:GetService("ReplicatedStorage"):WaitForChild("Remotes", 5)
    local damageEvent = remotes and remotes:WaitForChild("DamageBlockEvent", 5)
    
    while task.wait(1/7) do
        if Toggles.Aura and damageEvent then
            pcall(function()
                if workspace:FindFirstChild("HeartbreakerSammyRig") then
                    damageEvent:FireServer(workspace.HeartbreakerSammyRig)
                end
                local lbs = workspace:FindFirstChild("LuckyBlocks")
                if lbs then
                    for _, b in pairs(lbs:GetChildren()) do damageEvent:FireServer(b) end
                end
            end)
        end
    end
end)

-- Auto-Refresh List every 15s
task.spawn(function()
    while task.wait(15) do updateEliteList() end
end)
